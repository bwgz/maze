<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="maze-canvas.html">
<link rel="import" href="shared-styles.html">

<dom-module id="home-view">
    <template>
        <style include="shared-styles">
			:host {
                display: block;
                padding: 10px;
			}
        </style>
		<style is="custom-style">
			#container {
			  display: flex;
			}
			paper-button {
			  font-family: 'Roboto', 'Noto', sans-serif;
			  font-weight: normal;
			  font-size: 12px;
			  -webkit-font-smoothing: antialiased;
			}
			paper-button.green {
			  background-color: var(--paper-green-500);
			  color: white;
			}
			paper-button.green[active] {
			  background-color: var(--paper-red-500);
			}
		    :root {
		      --iron-autogrow-textarea: {
		          font-family: monospace !important;
		      }
		    }
		</style>
	    <iron-ajax
	        id="api"
	        url="http://localhost:8080/api/v1/maze"
	        content-type="application/json"
			method="post"
	        handle-as="json"
	        body="{{requestBody}}"
	        on-response="onResponse"
	        on-error="onError">
	    </iron-ajax>
	
        <template is="dom-if" if="[[maze]]">
            <style>
                .canvas-container {
                    width: 100%;
                    overflow: auto;
                }
            </style>
	        <div class="card">
	           <div class="canvas-container" >
	             <maze-canvas maze="[[maze]]" debug></maze-canvas>
                 <template is="dom-if" if="[[steps]]">
                    <p>The shortest path from start (green) to finish (red) has {{steps}} steps.</p>
		         </template>
                 <template is="dom-if" if="[[!steps]]">
                    <p>No path was found in this maze.</p>
                 </template>
	           </div>
	        </div>
        </template>
        
	    <div class="card">
	        <h1>Instructions</h1>
	          <p>Click on the  <paper-button class="green" on-click="openSubmitDialog" >Submit Maze</paper-button> button to enter your maze.</p>
	          <p>A valid maze may contain the following types of characters:</p>
	          <ul>
	             <li>`.` represents an open road</li>
	             <li>`#` represents a blocked road</li>
	             <li>`A` represents the starting point</li>
	             <li>`B` represents the destination point</li>
	          </ul>
	          <p>Here's an example of a maze.</p>
	          <p>
<pre>##########
#A...#...#
#.#.##.#.#
#.#.##.#.#
#.#....#B#
#.#.##.#.#
#....#...#
##########</pre>
	          </p>
	    </div>
        <paper-dialog id="submitDialog">
            <h2>Submit Maze</h2>
            
            <paper-dialog-scrollable>
                <paper-textarea id="input" class="fixed" style="width: 400px; height: 300px;"
                    label="Submit Maze"
					prevent-invalid-input
					auto-validate
					required
                    allowed-pattern="[#\.AB]"
					pattern="[#\.AB]"
					error-message="Please use the following characters - #.AB"
					value="{{input}}">
				</paper-textarea>
            </paper-dialog-scrollable>
            <div class="buttons">
                 <paper-button dialog-dismiss>Cancel</paper-button>
                 <paper-button on-tap="onSubmitDialog">Submit</paper-button>
            </div>
        </paper-dialog>
        
        <paper-dialog id="errorDialog">
            <p>Maze Submission Failed</p>
            
            <div class="buttons">
                 <paper-button dialog-dismiss>Cancel</paper-button>
                 <paper-button on-click="onSubmitDialog" dialog-confirm autofocus>Try Again</paper-button>
            </div>
        </paper-dialog>
    </template>

  <script>
  class HomeView extends Polymer.Element {
	  static get is() { return 'home-view'; }
	  static get properties() {
	    return {
	      input: {
	         type: String,
	         value: ""
	      },
          maze: {
              type: Object,
              value: null
           },
          steps: {
        	  type: Number,
        	  value: null
          },
	      requestBody: {
	          type: Object,
	          value: { maze: null /* [ "#####", "#A..#", "#.#.#", "#.#B#", "#...#", "#####" ] */ }
	        },
	    };
	  }
	  
	  openSubmitDialog() {
	      this.$.submitDialog.open();
	  }
	
	  onSubmitDialog(){
	      if (this.$.input.validate()) {
	          this.$.submitDialog.close();
	          this.requestBody.maze = this.input.split('\n');
	          this.$.api.generateRequest();
	      }
	  }
	  
      onError(e) {
    	  this.maze = null;
    	  this.steps = null;
          this.$.errorDialog.open();
      }
      
      onResponse(e) {
          this.maze = e.detail.response;
          
          if (this.maze.route.length == 0) {
        	  this.steps = null;
          }
          else {
        	  this.steps = this.maze.route.length - 1;
          }
      }
  }

  window.customElements.define(HomeView.is, HomeView);
  </script>
</dom-module>
